<!DOCTYPE html>
<html lang="cn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script type="text/javascript" src="../d3/d3.js"></script>
    <title>地图</title>
    <style>
        .svg{
            width:600px;
            display:block;
            margin-right:auto;
            margin-left:auto;
        }

        .title{
            text-align: center;
            font-size:40px;
        }

        #infotooltip{
            position: absolute;
            width: 200px;
            height: auto;
            padding: 10px;
            background-color: white;
            -webkit-border-radius: 10px;
            -moz-border-radius: 10px;
            border-radius: 10px;
            -webkit-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
            -moz-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
            box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
            pointer-events: none;
        }

        #infotooltip.hidden {
            display: none;
        }

        #infotooltip p{
            margin: 0;
            font-family: sans-serif;
            font-size: 16px;
            line-height: 20px;
        }
    </style>
</head>
<body>
    <!-- 
    参考文件:
    1.http://wiki.jikexueyuan.com/project/d3wiki/chinamap.html
        中国地图的制作过程和需要的数据

    -->

    <p class="title">国一毕业生去向表</p>

    <div id="infotooltip" class="hidden">
    </div>

    <script>
        var height=400;
        var width=600;

        var chinaprojection = d3.geoMercator()
                                .center([107, 31])
                                .translate([width/2,height/2+70])
                                .scale([500]);

        var chinapath = d3.geoPath()
                            .projection(chinaprojection);

        var chinacolor = d3.scaleQuantize()
                            .range(["rgb(252, 179, 179)","rgb(232, 136, 136)",
                                    "rgb(219, 98, 98)","rgb(216, 54, 54)"]);

        var svg = d3.select("body")
                    .append("svg")
                    .attr("class","svg")
                    .attr("width",width)
                    .attr("height",height);

        //draw the circle
        d3.csv("./city.csv",function(chinaCityData){
                svg.selectAll("circle")
                    .data(chinaCityData)
                    .enter()
                    .append("circle")
                    .attr("cx",function(d){
                        return chinaprojection([d.lon,d.lat])[0];
                    })
                    .attr("cy",function(d){
                        return chinaprojection([d.lon,d.lat])[1];
                    })
                    .attr("r",function(d){
                        if(0 !== parseInt(d.num)) return Math.sqrt(parseInt(d.num)*20)
                        else return 0;
                    })
                    .attr("id",function(d){return d.City_EN;})
                    .style("fill","rgb(255,242,0)")
                    .style("stroke","gray")
                    .style("stroke-width",0.25)
                    .style("opacity",0.75);
        });

        //draw the path
        d3.csv("./province.csv",function(chinadata){
            
            //set domain of quantize scale
            chinacolor.domain([
                d3.min(chinadata,function(chinad){return chinad.Num;}),
                d3.max(chinadata,function(chinad){return chinad.Num;})
            ]);
            
            //draw the map/path
            d3.json("china.json",function(chinajson){

                //merge the csv into json
                for(var i = 0;i<chinadata.length;i++){

                    var Num = parseFloat(chinadata[i].Num);
                    var dataProvince = chinadata[i].Province;

                    for(var j =0 ;j<chinajson.features.length;j++){

                        var jsonProvince = chinajson.features[j].properties.name;

                        if(jsonProvince == dataProvince){
                            //the new added property are called num
                            chinajson.features[j].properties.num = Num;
                            break;
                        }
                    }
                };

                //bind the json with path element;
                //append path element
                svg.selectAll("path")
                    .data(chinajson.features)
                    .enter()
                    .append("path")
                    .attr("d",chinapath)
                    .attr("fill",function(d){
                        var num = d.properties.num;
                        var fill;

                        if(num){
                            fill = chinacolor(num);
                        }else{
                            fill = "#ccc";
                        }
                        return fill;
                    })
                    .style("stroke","white")
                    .style("stroke-width",0.1)
                    .on("mouseover",pathMouseoverHandler)
                    .on("mouseout",pathMouseoutHandler);

                    //handler
                    function pathMouseoverHandler(){
                        this.attr("fill","rgb(210, 43, 43)");
                    }
                    function pathMouseoutHandler(){
                        this.attr("fill",function(d){
                        var num = d.properties.num;
                        var fill;

                        if(num){
                            fill = chinacolor(num);
                        }else{
                            fill = "#ccc";
                        }
                        return fill;
                        });
                    }

            });

            
        });

        //append event handler
        d3.csv("./student.csv",function(chinaStudentData){
                //遍历所有圆
                var circles = svg.selectAll("circle");
                circles.on("mouseover",mouseoverhandler);
                circles.on("mouseout",mouseouthandler);                
                
                function mouseoverhandler(){
                    var r = parseFloat(this.r.baseVal.valueAsString);
                    if(r === 0){
                        //r为0的城市,也就是没有学生去的城市,不显示.
                    }
                    else{
                        console.log(this.__data__.City_EN);
                        //吧所有符合条件的学生的信息收集到数组中
                        var studentEntitled = [];
                        var city_en = this.__data__.City_EN;//这个圆绑定的数据

                        for(var i = 0;i<chinaStudentData.length;i++){
                            //遍历学生的数据
                            if(chinaStudentData[i].City_EN === city_en)
                                studentEntitled.push({Name:chinaStudentData[i].Name,Collage:chinaStudentData[i].Collage});
                        }
                        
                        //然后显示信息框,在信息框中显示对象数组中的信息.
                        //信息框草图见草稿纸
                        //获取坐标
                        var left = 340 + parseFloat(this.cx.animVal.valueAsString) + 5+ parseFloat(this.r.animVal.valueAsString);
                        var top = 132.6 + parseFloat(this.cy.animVal.valueAsString) - parseFloat(this.r.animVal.valueAsString);
                        console.log(left);
                        console.log(top);

                        
                        //获得tooltip元素
                        var tooltip = d3.select("#infotooltip");
                        tooltip.style("left", left + "px")
                            .style("top", top + "px");

                        tooltip = document.getElementById("infotooltip");
                       
                        //append title
                        var cityname = this.__data__.City;
                        var title = document.createElement("p");
                        var titleContent = document.createTextNode(cityname);
                        title.appendChild(titleContent);
                        title.className="title";
                        tooltip.appendChild(title);

                        //append students info
                        for(var i =0 ; i<studentEntitled.length;i++){
                            var info = studentEntitled[i].Name + "-" + studentEntitled[i].Collage;
                            var para = document.createElement("p");
                            var text = document.createTextNode(info);
                            para.appendChild(text);

                            tooltip.appendChild(para);
                        }

                        //show the tooltip
                        d3.select("#infotooltip").classed("hidden",false); 
                    }
                }

                function mouseouthandler(){
                    //delete all stud info
                    var tooltip = document.getElementById("infotooltip");
                    tooltip.innerHTML = "";
                    //hiden
                    d3.select("#infotooltip").classed("hidden",true); 
                }
            });
        
    </script>

   
</body>
</html>